
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://Tea-n-Tech.github.io/chia-tea/architecture_summary/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>Architecture Guide - Chia-Tea üåøüçµ</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#architecture-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Chia-Tea üåøüçµ" class="md-header__button md-logo" aria-label="Chia-Tea üåøüçµ" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Chia-Tea üåøüçµ
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Architecture Guide
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Chia-Tea üåøüçµ" class="md-nav__button md-logo" aria-label="Chia-Tea üåøüçµ" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Chia-Tea üåøüçµ
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../quick_start/" class="md-nav__link">
        Quick-Start
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Architecture Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Architecture Guide
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    Disclaimer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#copy-plots" class="md-nav__link">
    Copy-Plots
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    Monitoring
  </a>
  
    <nav class="md-nav" aria-label="Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chia-watchdog" class="md-nav__link">
    Chia Watchdog
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protobuf-protocol" class="md-nav__link">
    Protobuf Protocol
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-storage" class="md-nav__link">
    Data Storage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-schema" class="md-nav__link">
    Table Schema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sqlite-schema-generation" class="md-nav__link">
    Sqlite Schema Generation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throttling" class="md-nav__link">
    Throttling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-security" class="md-nav__link">
    Connection Security
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-version-compatability" class="md-nav__link">
    Database Version Compatability
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    Disclaimer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#copy-plots" class="md-nav__link">
    Copy-Plots
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    Monitoring
  </a>
  
    <nav class="md-nav" aria-label="Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chia-watchdog" class="md-nav__link">
    Chia Watchdog
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protobuf-protocol" class="md-nav__link">
    Protobuf Protocol
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-storage" class="md-nav__link">
    Data Storage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-schema" class="md-nav__link">
    Table Schema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sqlite-schema-generation" class="md-nav__link">
    Sqlite Schema Generation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throttling" class="md-nav__link">
    Throttling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-security" class="md-nav__link">
    Connection Security
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-version-compatability" class="md-nav__link">
    Database Version Compatability
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="architecture-guide">Architecture Guide</h1>
<h2 id="disclaimer">Disclaimer</h2>
<p>The codebase has evolved very drastically over the last months.
This caused side-effects such as unneccesary functions, complex logic here or
there or obscure classes, which haven't been refactored yet.
Also testing is quite low, since the software architecure changed so much all
the time, that it was too much effort to keep it up in the unstable parts of
the code.
On the road to our first stable release, we will take care of these aspects step
by step.</p>
<h2 id="copy-plots">Copy-Plots</h2>
<p>This module contains code to copy plots from multiple source directories to
multiple target directories.
When choosing a disk it takes multiple factors into account such as how mandy
plots are already being copied onto that drive.
Also the entire process is quite fault-tolerant to disconnects or other issues.
While it is not perfect, it does it's job very well for us.</p>
<h2 id="monitoring">Monitoring</h2>
<h3 id="chia-watchdog">Chia Watchdog</h3>
<p>The chia watchdog is the source of chia of data collection.
It is also the oldest part of the code from a time before the monitoring layer
was added.
It consists of a single class <code>ChiaWatchdog</code> with additional class members.
These classes are permanently modified by:</p>
<ul>
<li>logfile changes</li>
<li>fetching data directly from chia via API calls</li>
<li>self-checks run periodically</li>
</ul>
<p>This information is partially converted into protobuf messages and sent to the
server.
We don't send everything since some data is just for computations.
For example we keep the signage point timestamps to check if a harvester missed
a challenge but sending all that data is a waste.
It makes more sense to simply send the amount of missed challenges and that's
it.</p>
<h3 id="protobuf-protocol">Protobuf Protocol</h3>
<p>The collected chia data needs to be sent from the monitoring clients to the
monitoring server.
The glue for this task is the communication protocol written in
[Protobuf][protobuf].
This protocol defines two things: which data is sent from the monitored machines
to the server but also what data is stored in the database.
The protocol can be found in the folder <code>protocol</code> and the generated source
code can be found under <code>chia_tea.protobuf.generated</code>.
There is also a [GRPC][grpc] service definition, which defines the communication
functions between server and client.</p>
<p>The module <code>chia_tea.monitoring.data_collection</code> converts the <code>ChiaWatchdog</code>
data into protobuf messages.
It also contains the code to collect hardware information but this will be
seperated in the future.</p>
<h3 id="data-storage">Data Storage</h3>
<p>The library uses <a href="https://docs.python.org/3/library/sqlite3.html"><code>sqlite3</code></a> to
store monitoring data on disk.
There are two types of tables:</p>
<p>There are two important tables:</p>
<ul>
<li>Update Event Table</li>
<li>State Table</li>
</ul>
<p>The update event table stores all update events ever received for a topic.
For example the <code>CpuInfoEvents</code> table contains all cpu data for all machines.
To get a fast and easy overview over the current status there is also a state
table.
In case of the cpu this is <code>CpuInfo</code>.
The state table is modified according to the update events, thus if a DELETE
event for example is received an entry will be deleted.</p>
<h3 id="table-schema">Table Schema</h3>
<p>The state table uses solely <code>machine_id</code> as primary key to distinguish entries
whereas events also use <code>timestamp</code> and <code>event_type</code>.
In case an entry is <code>repeatable</code> in protobuf such as a harvester reporting
multiple plots for a single machine, then an additional field <code>id</code> is used as
part of the primary key to distinguish data entries.</p>
<h3 id="sqlite-schema-generation">Sqlite Schema Generation</h3>
<p>The module <code>chia_tea.protobuf.to_sqlite</code> is the bridge between protobuf and
sqlite.
It generically defines functions to store or retrieve protobuf messages from
sqlite.
The code is generic so that almost all changes made to the proto files are
automatically handled.
While the code works well, it requires severe refactoring to be more
understandable and usable.</p>
<p>Limitations are at the moment that enums as well as nested messages cannot be
dealt with.</p>
<h3 id="throttling">Throttling</h3>
<p>The client only sends data if any changes occured.
This is always the case for strongly varying metrics such as CPU usage.
To avoid spamming the server and thus the database, the submission of such data
is throttled in the client config under <code>monitoring.client.send_update_every</code>.
We recommend to transmit such data no faster than once per minute.
Important data such as harvester connectivity is not throttled at all and the
event is transmitted once being captured.</p>
<h3 id="connection-security">Connection Security</h3>
<p>The connection is secured by two certificates (.key and .cert).
The filepaths are specified in the <code>config.yml</code> under <code>monitoring.auth</code>.
While the monitoring server requires both files '.key' and '.cert', a client
uses solely '.cert' to authenticate against the server.</p>
<h3 id="database-version-compatability">Database Version Compatability</h3>
<p>Since the database is generated from protobuf, changing the protocol may
require to delete the old database since the tables are inconsistent.
This will be addressed in the future.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../quick_start/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Quick-Start" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Quick-Start
            </div>
          </div>
        </a>
      
      
        
        <a href="../faq/" class="md-footer__link md-footer__link--next" aria-label="Next: FAQ" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              FAQ
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.467223ff.min.js"></script>
      
    
  </body>
</html>